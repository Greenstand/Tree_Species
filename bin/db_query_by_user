#!/bin/sh

# Authorization:
# 1. You will need to first access dbuser@bp1.treetracker.org via:
#   ssh -i ./dbuser.id_rsa dbuser@bp1.treetracker.org
# with the ssh private key and password, as provided by GS
# and add a rsa public key to the remote .ssh/authorized_keys file
# 2. Create a file in this directory called `passwords` with a single
# line: `dbsql PSQLPASS`, where PSQLPASS is the pgsql password, from GS

cd "$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

# Usages test
if [ $# = 0 ]
then
    echo "Usage: db_query_by_user <adminpanel_username>"
    exit 1
fi

# Create tunnel
ssh -fN -L 1111:treetracker-cluster-read-only-37982-do-user-8540031-0.b.db.ondigitalocean.com:25060 dbuser@bp1.treetracker.org
PID=`ps auwx | grep ssh | grep treetracker | gawk '{printf "%d", $2}'`
# echo "(ssh PID: ${PID})"

# For trees, default
# SQL="\\pset format unaligned\n \
#   SELECT trees.image_url, lat, lon, \
#     audit.created_at AS time , admin_user.user_name, \
#     CONCAT_WS(' ', admin_user.first_name, admin_user.last_name) AS person, \
#     entity.name AS org, tree_species.name AS species \
#   FROM audit, trees, tree_species, admin_user, entity, planter \
#   WHERE (audit.operation->'payload'->>'speciesId')::integer = tree_species.id \
#     AND audit.admin_user_id = admin_user.id \
#     AND admin_user.user_name = '"$1"' \
#     AND (audit.operation->'payload'->>'id')::integer = trees.id \
#     AND trees.planter_id = planter.id \
#     AND planter.organization_id = entity.id;"

SQL="\\pset format unaligned\n \
select trees.image_url, lat, lon, a.cid, a.t, tree_species.name from (select (audit.operation->'payload'->>'id')::integer as cid, max(audit.created_at) t from audit, admin_user where audit.admin_user_id = admin_user.id and admin_user.user_name = '"$1"' group by cid order by cid) as a left join (select (audit.operation->'payload'->>'id')::integer as cid, audit.created_at as t, (audit.operation->'payload'->>'speciesId')::integer as spid from audit) as b on a.cid = b.cid and a.t = b.t left join tree_species on b.spid = tree_species.id left join trees on a.cid = trees.id;"

SQLPW=`grep dbsql passwords | gawk '{printf "%s", $2}'`

# Execute SQL
echo -e "$SQL" | psql "sslmode=require host=localhost dbname=treetracker user=readonlyuser port=1111 password=$SQLPW"

# kill tunnel
kill -9 $PID
